---
title: "ANES-CDF-Data"
---

The 2022-09-16 version of the ANES CDF is openly available to export at the following [link](https://electionstudies.org/data-center/anes-time-series-cumulative-data-file/)

Citation:
American National Election Studies. 2022. ANES Time Series
Cumulative Data File [dataset and documentation]. September 16,
2022 version. www.electionstudies.org


```{r}
#| label: setup


# set seed for reproducibility
set.seed(12345)

# load custom functions
source(here::here("utils", "funs.R"))

# load packages
library(tidyverse)
library(fipio)

# load data
anesCDF <- haven::read_sav("data-raw/anes_timeseries_cdf_spss_20220916.sav")



```


```{r}
#| label: save_codebook

# use custom function to create ANES CDF codebook
anesCDF_codebook <- codebook(anesCDF)


# save data dictionary to resources directory
readr::write_csv(x = anesCDF_codebook, file = "resources/anes resources/anesCDF_codebook.csv")

```

```{r}
#| label: subset_df


# cdf = cumulative data file
# subset dataframe by desired variables from ANES variable codebook
cdf <- anesCDF |>
  janitor::clean_names() |>
  dplyr::select(
    anes_version          = version,
    year                  = vcf0004,
    case_id               = vcf0006,
    panelcase_id          = vcf0006a,
    weights9x             = vcf0009x,
    weights9y             = vcf0009y,
    weights9z             = vcf0009z,
    weights10x            = vcf0010x,
    weights10y            = vcf0010y,
    weights10z            = vcf0010z,
    weights11x            = vcf0011x,
    weights11y            = vcf0011y,
    weights11z            = vcf0011z,
    weights_vcf9999       = vcf9999,
    post_electionIW       = vcf0013,
    pre_electionIW        = vcf0014,
    cross_sec_comp        = vcf0016,
    interview_mode        = vcf0017,
    age                   = vcf0101,
    age_group             = vcf0102,
    cohort                = vcf0103,
    gender                = vcf0104,
    race_7cat             = vcf0105a,
    race_4cat             = vcf0105b,
    race_3cat             = vcf0106,
    hisp_orgin_type       = vcf0107,
    hisp_orgin            = vcf0108,
    educ_4cat             = vcf0110,
    census_region         = vcf0112,
    political_south       = vcf0113,
    income_group          = vcf0114,
    hh_union_mbr          = vcf0127,
    union_who             = vcf0127b,
    relig_major           = vcf0128,
    relig_7cat            = vcf0128a,
    relig_8cat            = vcf0128b,
    educ_6cat             = vcf0140,
    educ_7cat             = vcf0140a,
    birthplace            = vcf0142,
    parents_native        = vcf0143,
    partyid               = vcf0301,
    partyid_3cat          = vcf0303,
    interest_in_elections = vcf0310,
    care_who_wins         = vcf0311,
    care_who_wins_house   = vcf0312,
    attention             = vcf0313,
    pres_app_anes         = vcf0450,
    pres_app_strngth      = vcf0451,
    protest_approval      = vcf0601,
    civildisobedience     = vcf0602,
    demonstrations        = vcf0603,
    trust1                = vcf0604,
    trust2                = vcf0605,
    trust3                = vcf0606,
    trust4                = vcf0608,
    nocare                = vcf0609,
    nosay                 = vcf0613,
    complex               = vcf0614,
    govrespons_elections  = vcf0624,
    exteff                = vcf0648,
    govresp               = vcf0649,
    trustgov              = vcf0656,
    turnout               = vcf0702,
    regis_turnout         = vcf0703,
    votechoice_candiates  = vcf0704,
    votechoice_2party     = vcf0704a,
    votechoice            = vcf0705,
    voted                 = vcf0706,
    vote_party_house      = vcf0736,
    betteroff             = vcf0880,
    betteroffa            = vcf0880a,
    betteroff_next_year   = vcf0881,
    congdist              = vcf0900,
    stcd_fips             = vcf0900b,
    stcd_abb              = vcf0900c,
    st_fips               = vcf0901a,
    st_abb                = vcf0901b,
    pres_app_econ         = vcf9009
  )


```

```{r}
#| label: rename_columns

# save character vector of new column names corresponding to ANES var names 
# (technically a named character object)
new_var_names <- c(
  anes_version          = "version",
  year                  = "vcf0004",
  case_id               = "vcf0006",
  panelcase_id          = "vcf0006a",
  weights9x             = "vcf0009x",
  weights9y             = "vcf0009y",
  weights9z             = "vcf0009z",
  weights10x            = "vcf0010x",
  weights10y            = "vcf0010y",
  weights10z            = "vcf0010z",
  weights11x            = "vcf0011x",
  weights11y            = "vcf0011y",
  weights11z            = "vcf0011z",
  weights_vcf9999       = "vcf9999",
  post_electionIW       = "vcf0013",
  pre_electionIW        = "vcf0014",
  cross_sec_comp        = "vcf0016",
  interview_mode        = "vcf0017",
  age                   = "vcf0101",
  age_group             = "vcf0102",
  cohort                = "vcf0103",
  gender                = "vcf0104",
  race_7cat             = "vcf0105a",
  race_4cat             = "vcf0105b",
  race_3cat             = "vcf0106",
  hisp_orgin_type       = "vcf0107",
  hisp_orgin            = "vcf0108",
  educ_4cat             = "vcf0110",
  census_region         = "vcf0112",
  political_south       = "vcf0113",
  income_group          = "vcf0114",
  hh_union_mbr          = "vcf0127",
  union_who             = "vcf0127b",
  relig_major           = "vcf0128",
  relig_7cat            = "vcf0128a",
  relig_8cat            = "vcf0128b",
  educ_6cat             = "vcf0140",
  educ_7cat             = "vcf0140a",
  birthplace            = "vcf0142",
  parents_native        = "vcf0143",
  partyid               = "vcf0301",
  partyid_3cat          = "vcf0303",
  interest_in_elections = "vcf0310",
  care_who_wins         = "vcf0311",
  care_who_wins_house   = "vcf0312",
  attention             = "vcf0313",
  pres_app_anes         = "vcf0450",
  pres_app_strngth      = "vcf0451",
  protest_approval      = "vcf0601",
  civildisobedience     = "vcf0602",
  demonstrations        = "vcf0603",
  trust1                = "vcf0604",
  trust2                = "vcf0605",
  trust3                = "vcf0606",
  trust4                = "vcf0608",
  nocare                = "vcf0609",
  nosay                 = "vcf0613",
  complex               = "vcf0614",
  govrespons_elections  = "vcf0624",
  exteff                = "vcf0648",
  govresp               = "vcf0649",
  trustgov              = "vcf0656",
  turnout               = "vcf0702",
  regis_turnout         = "vcf0703",
  votechoice_candiates  = "vcf0704",
  votechoice_2party     = "vcf0704a",
  votechoice            = "vcf0705",
  voted                 = "vcf0706",
  vote_party_house      = "vcf0736",
  betteroff             = "vcf0880",
  betteroffa            = "vcf0880a",
  betteroff_next_year   = "vcf0881",
  congdist              = "vcf0900",
  stcd_fips             = "vcf0900b",
  stcd_abb              = "vcf0900c",
  st_fips               = "vcf0901a",
  st_abb                = "vcf0901b",
  pres_app_econ         = "vcf9009"
)

# In codebook of full ANES CDF, prefix all strings in `label` with
# string identifying ANES variable code
anesCDF_codebook <- anesCDF_codebook |> 
  dplyr::mutate(label = stringr::str_glue("[{variable}]: {label}"))

# create a data dictionary of subset dataframe. This retains all of the same
# variable labels (`label`) and value labels (`value_labels`), and values
# (codes) as the origin ANES CDF data set. while also replacing the `variable`
# character strings with the renamed variable columns of the subsetted data
# frame
cdf_codebook <- anesCDF_codebook |>
  dplyr::mutate(variable = janitor::make_clean_names(variable)) |> 
  dplyr::filter(variable %in% new_var_names) |> 
  dplyr::mutate(variable = names(new_var_names))

# remove redundant dataframe from environment
rm(anesCDF, anesCDF_codebook, new_var_names)


```

```{r}
#| label: save_as_rds

# Save subset of ANES CDF and data dictionary/codebook as rds
readr::write_rds(cdf, file = "data/anes_cdf_subset.rds")
readr::write_rds(cdf_codebook, file = "data/anes_cdf_subset_data_codebook.rds")


```

## Applying supplied weights to the `cdf` dataframe


The ANES CDF supplies weights, which must be used. How I incorporate this into
the analysis, however, isn't clear to me. I am using repeated cross-sectional
data, but I know of no function or method for using the weights supplied. It's
far easier to use a single study, but this is a cumulative data set of
multiple studies. The best approach I see is to construct a survey design
object.

The correct weight variable to use from the ANES CDF is `VCF0009z`
Since I am using the combined sample (FTF and web) from 2012, and the External
efficacy items indicate `Type 0` for 1970 time series, then I must use the
variable `VCF0009z`
The weight variable to use is the combined sample (i.e., FTF and Web) with
1970 Type 0

Just to Note: the ANES also includes a full sample post-election weight
variable (VCF9999) for study years and cases for which a post-election weight
is available.

```{r}
#| label: apply_wts

# apply weights
cdf_wt <- srvyr::as_survey_design(weights = weights9z, .data = cdf)
```


```{r}
#| label: replace_999

# For the indices in the ANES CDF, code `999` refers to missing/NA
# recode `999` as NA for external efficacy, gov responsiveness, and trust in gov
# indices
cdf_wt <- cdf_wt |> 
  srvyr::mutate(across(c(exteff, govresp, trustgov), 
                       ~dplyr::na_if(., 999)))
```


```{r}
#| label: recode_0_as_na

# for many variables/items, `0` = NA; no Post IW, etc. So recode `0` as NA
# it's too risky to simply blanket re-code every `0` as NA for every variable,
# so I'll only do the few I know for sure are coded in that way.
cdf_wt <- cdf_wt |>
  srvyr::mutate(across(
    c(nosay, nocare, trust1, trust2, trust3, trust4),
    ~ dplyr::na_if(., 0)
  ))



```


## States, Census regions, FIPS, and further processing of dataframe

```{r}
# replace certain values with NA
cdf_wt <- cdf_wt |>
  srvyr::mutate(
    st_abb = dplyr::na_if(st_abb, "99"),
    census_region = dplyr::na_if(census_region, 0),
    stcd_fips = dplyr::na_if(stcd_fips, 9999),
    stcd_abb = dplyr::na_if(stcd_abb, "9999")
  )

```


```{r}


# convert select geographic variables to factor
cdf_wt |>
  srvyr::mutate(census_region = sjlabelled::set_labels(
    census_region,
    labels = c(
      "Northeast" = 1,
      "North Central" = 2,
      "West" = 3,
      "South" = 4
    )
  )) |>
  srvyr::mutate(
    political_south = sjlabelled::set_labels(political_south, labels = c(
    "South" = 1, "Non-South" = 2
  ))) |>
  srvyr::mutate(across(c(census_region, political_south),
    ~ sjlabelled::as_label(., prefix = TRUE)
  )) |>
  srvyr::mutate(srvyr::across(c(st_abb, stcd_abb), ~ forcats::as_factor(.)))


# year variable also needs to be a factor
cdf_wt <- cdf_wt |> 
  srvyr::mutate(year.f = forcats::as_factor(year), .after = year)


```

## Save the subset `cdf_wt` dataframe

```{r}

# just so I don't have to do it again
readr::write_rds(cdf_wt, file = "data/anes_cdf_wts_tbl_svy.rds")


```

